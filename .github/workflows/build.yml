name: build and deploy signal
on:
  push:
    pull_request:
      branches:
        - main
        - master
    tags:
      - '*'
        #branches:
        #  - main
        #  - master
        #  - testing
  workflow_dispatch:
    inputs:
      arch:
        type: choice
        description: Architecture
        options:
        - both
        - x86_64
        - aarch64
jobs:
  pre-run:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-24.04
    name: workflow_dispatch pre-run info
    steps:
      - name: workflow_dispatch pre-run info
        run: |
          echo "event name ${{ github.event_name }}"
          echo "arch ${{ github.event.inputs.arch }}"
          echo "logic aarch64: ${{ github.event_name != 'workflow_dispatch' || ( github.event_name == 'workflow_dispatch' && ( github.event.inputs.arch == 'both' || github.event.inputs.arch == 'aarch64' ) ) }}"
          echo "logic x86_64: ${{ github.event_name != 'workflow_dispatch' || ( github.event_name == 'workflow_dispatch' && ( github.event.inputs.arch == 'both' || github.event.inputs.arch == 'x86_64' ) ) }}"


  a-publish-release:
    if: startsWith(github.ref, 'refs/tags/')
    #runs-on: self-hosted
    runs-on: ubuntu-24.04
    name: '1 publish release'
    steps:
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: ncipollo/release-action@v1
        id: create_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          allowUpdates: true
          draft: false
          prerelease: false
          name: ${{ github.ref }}
          tag: ${{ github.ref }}

  b-build:
    #runs-on: self-hosted
    runs-on: ubuntu-24.04
    name: 'build'
    steps:
      - name: Set env.BRANCH
        run: echo "BRANCH=$(echo $GITHUB_REF | cut -d'/' -f 3)" >> $GITHUB_ENV
      - name: install secrets
        shell: bash
        env:
          GPG_KEY: ${{secrets.GPG_KEY}}
        run: |
          sudo apt-get update
          sudo apt-get install -qq -y gpg openssh-client
          echo "$GPG_KEY" | gpg --import
      - name: checkout code
        uses: actions/checkout@v4
      - name: install deps
        shell: bash
        run: |
          sudo apt-get update && sudo apt-get install -qq -y bash rsync flatpak elfutils coreutils binfmt-support fuse-overlayfs flatpak-builder qemu-user-static python3 gcc g++ make build-essential git git-lfs libffi-dev libssl-dev libglib2.0-0 libnss3 libatk1.0-0 libatk-bridge2.0-0 libx11-xcb1 libgdk-pixbuf-2.0-0 libgtk-3-0 libdrm2 libgbm1 ruby ruby-dev curl wget clang llvm lld clang-tools generate-ninja ninja-build pkg-config tcl wget libpixman-1-dev libcairo2-dev libpango1.0-dev
      - name: install flatpak deps
        shell: bash
        env:
          CI_USER: runner
        run: |
          sudo rm -rf /opt/pakrepo/
          sudo mkdir -p /opt/pakrepo
          sudo chown "$USER" /opt/pakrepo
          sudo flatpak update --noninteractive -y
          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          sudo flatpak install --noninteractive --arch=aarch64 flathub org.electronjs.Electron2.BaseApp//24.08 org.freedesktop.Platform//24.08 org.freedesktop.Sdk//24.08 org.freedesktop.Sdk.Extension.node20//24.08 -y
          sudo flatpak install --noninteractive --arch=x86_64 flathub org.electronjs.Electron2.BaseApp//24.08 org.freedesktop.Platform//24.08 org.freedesktop.Sdk//24.08 org.freedesktop.Sdk.Extension.node20//24.08 -y
      - name: setup flatpaks
        env:
          BRANCH: "7.44.x"
        shell: bash
        run: |
          git clone https://github.com/flatpak/flatpak-builder-tools.git
          cd flatpak-builder-tools/node
          pipx install .
          cd ../../
          export PATH=/opt/pipx_bin:$PATH
          git clone https://github.com/signalapp/Signal-Desktop.git -b $BRANCH
          cd Signal-Desktop
          NODE_VERSION=v20.18.1
          wget -q https://nodejs.org/dist/"$NODE_VERSION"/node-"$NODE_VERSION"-linux-x64.tar.gz
          tar xf node-"$NODE_VERSION"-linux-x64.tar.gz
          mv node-"$NODE_VERSION"-linux-x64 node
          PATH=$PWD/node/bin:$PATH
          # npm install -g pnpm-lock-to-npm-lock
          # pnpm-lock-to-npm-lock pnpm-lock.yaml
          flatpak-node-generator npm package-lock.json
          cp generated-sources.json ../
      - name: build flatpaks
        shell: bash
        env:
          build_x86_64: ${{ github.event_name != 'workflow_dispatch' || ( github.event_name == 'workflow_dispatch' && ( github.event.inputs.arch == 'both' || github.event.inputs.arch == 'x86_64' ) ) }}
          build_aarch64: ${{ github.event_name != 'workflow_dispatch' || ( github.event_name == 'workflow_dispatch' && ( github.event.inputs.arch == 'both' || github.event.inputs.arch == 'aarch64' ) ) }}
        run: |
          # amd64
          if [[ "$build_x86_64" == "true" ]];then
            flatpak-builder --arch=x86_64 --gpg-sign=FBEF43DC8C6BE9A7 --repo=/opt/pakrepo --force-clean .builddir flatpak.yml
            flatpak build-bundle --arch=x86_64 /opt/pakrepo ./signal_amd64.flatpak org.signal.Signal master
            sha256sum ./signal_amd64.flatpak | tee -a checksums.txt
          fi
          # arm64
          if [[ "$build_aarch64" == "true" ]];then
            flatpak-builder --arch=aarch64 --gpg-sign=FBEF43DC8C6BE9A7 --repo=/opt/pakrepo --force-clean .builddir flatpak.yml
            flatpak build-bundle --arch=aarch64 /opt/pakrepo ./signal_arm64.flatpak org.signal.Signal master
            sha256sum ./signal_arm64.flatpak | tee -a checksums.txt
          fi
      - name: Upload checksums.txt
        uses: actions/upload-artifact@v4
        with:
          path: checksums.txt
          name: checksums.txt
      - name: Upload amd64 flatpak
        if: ${{ github.event_name != 'workflow_dispatch' || ( github.event_name == 'workflow_dispatch' && ( github.event.inputs.arch == 'both' || github.event.inputs.arch == 'x86_64' ) ) }}
        uses: actions/upload-artifact@v4
        with:
          path: signal_amd64.flatpak
          name: signal_amd64.flatpak
      - name: Upload arm64 flatpak
        if: ${{ github.event_name != 'workflow_dispatch' || ( github.event_name == 'workflow_dispatch' && ( github.event.inputs.arch == 'both' || github.event.inputs.arch == 'aarch64' ) ) }}
        uses: actions/upload-artifact@v4
        with:
          path: signal_arm64.flatpak
          name: signal_arm64.flatpak

      # Publish
      - name: Upload release artifacts
        if: startsWith(github.ref, 'refs/tags/')
        env:
          VERSION: "7.44.0"
        uses: AButler/upload-release-assets@v3.0
        with:
          release-tag: ${{ env.VERSION }}
          files: "signal_amd64.flatpak;signal_arm64.flatpak;checksums.txt"
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: checkout gh-pages branch
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/checkout@v4
        with:
          ref: 3bfa32a90c7bdd769a0e2235f66bd1aec0310ec3
      - name: sync to gh-pages branch repo dir and commit
        if: startsWith(github.ref, 'refs/tags/')
        env:
          VERSION: "7.44.0"
        shell: bash
        run: |
          rsync -a --delete /opt/pakrepo/ ./repo/
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          git config --global user.name "${{ github.actor }}"
          git add repo
          git commit -m "repo update for $VERSION"
          git push -f origin HEAD:gh-pages
